<p>
    The month May marks the first year anniversary of a client project I've been working on at Spatie.
    I thought it useful to share some statistics with the community,
    to give a feeling what a "real life web project" might look like.
</p>

<p>
    Let's start with a general overview.
    The project is a long-running web application.
    Right now it features a comprehensive admin interface to manage inventories, contacts and contracts;
    bookings, automatic invoicing and ±10 third party integrations.
</p>

<p>
    In the future we'll be exposing several features to the outside via an API,
    its main goal to power a mobile app for clients of the platform.
</p>

<p>
    The project is built in Laravel, a <abbr>PHP</abbr> framework.
    We use Blade as a templating engine in combination with many VueJS components.
    Tailwind is the <abbr>CSS</abbr> framework used.
</p>

<h2>
    Some numbers
</h2>

<p>
    So, how many code have we written the past year? Here's a summary:
</p>

<p>
<ul>
    <li><span class="number">2,062</span> files</li>
    <li><span class="number">126,736</span> lines of code</li>
    <li><span class="number">97,423</span> logical lines of code</li>
</ul>
</p>

<p>
    And here's some more information about the <abbr>PHP</abbr> code:
</p>

<p>
<ul>
    <li><span class="number">32</span> interfaces; <span class="number">28</span> traits</li>
    <li><span class="number">1,086</span> classes</li>
    <li>Average <abbr>LLOC</abbr> of classes: <span class="number">8</span></li>
    <li>Maximum <abbr>LLOC</abbr> of classes: <span class="number">139</span></li>
    <li><span class="number">3,245</span> public methods</li>
    <li>Average <abbr>LLOC</abbr> of methods: <span class="number">2</span></li>
    <li>Maximum <abbr>LLOC</abbr> of methods: <span class="number">28</span></li>
</ul>
</p>

<p>
    Split per file type, it looks like this:
</p>

<p>
    <canvas id="chart-lloc" width="400" height="250"></canvas>
</p>

<p>
    Let's further dive into how the backend code is structured:
</p>

<p>
<ul>
    <li><span class="number">123</span> controllers; <span class="number">309</span> routes</li>
    <li><span class="number">78</span> database tables; <span class="number">149</span> migrations</li>
    <li><span class="number">840</span> tests; <span class="number">1,728</span> assertions</li>
</ul>
</p>

<h2>Interpreting these numbers</h2>

<p>
    Over the course of time, we moved in many cases from controllers with multiple actions to single action controllers.
    While I still think the basic <abbr>CRUD</abbr> controller (literally two lines of code per action) doesn't need to be split across multiple classes;
    I did notice it's easier to reason about complex parts of the application flow with single action controllers.
</p>

<p>
    Also notice there are twice as much migrations compared to the amount of database tables.
    A few months ago we moved the project into its testing phase on a staging server,
    which meant the client themselves were testing with "real" data.
    We weren't able to simply reset the database every time we made updates to it.
</p>

<p>
    Since this testing phase, client feedback and migrations started to grow.
    It would be nice if Laravel had an automated way of merging migrations after they have been deployed,
    as they slow down the startup time of our test suite.
    Luckily we're using transaction rollbacks in tests, so the impact is minimal.
</p>

<p>
    Speaking of tests:
    the bulk of the business logic of this application is contained in what we call "domains" — I've
    blogged about them <a href="/blog/organise-by-domain" target="_blank" rel="noopener noreferrer">before</a>.
</p>

<p>
    I'm happy to say we've managed to keep our domain code thoroughly tested.
    This is the single most important reason why we've been able to deal so well with scope changes during the testing phase:
    we're able to refactor lots of code, without the worry of breaking anything business related.
</p>

<p>
    On the other hand, controllers, request validation and middlewares are almost not unit tested.
    We have a few integration tests in place, some using plain phpunit, some using Laravel Dusk and Selenium.
</p>

<p>
    These integration tests ensure that critical parts of the app still work after refactorings,
    and they give enough certainty for us to feel comfortable.
    We could try and test everything, but the truth is that this would take way too much time and prevent us to meet deadlines.
</p>

<p>
    By extracting all business logic from controllers into domains and testing these,
    I feel like we've created a realistic balance.
</p>

<h2>
    In closing
</h2>

<p>
    Finally, I want to show the <abbr>GIT</abbr> history of the project visualised,
    we've been working on it with, in total, <span class="number">7</span> contributors, and now have more than <span class="number">4,000</span> commits listed.
</p>

<p>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/KkgAnOklQ7w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" integrity="sha256-Uv9BNBucvCPipKQ2NS9wYpJmi8DTOEfTA/nH2aoJALw=" crossorigin="anonymous"></script>
<script>
    new Chart(document.getElementById('chart-lloc'), {
        type: 'bar',
        data: {
            labels: ["php", "blade", "javascript", "css"],
            datasets: [
                {
                    label: "Code",
                    backgroundColor: "pink",
                    borderColor: "red",
                    borderWidth: 1,
                    data: [73424, 9432, 7947, 6619]
                },
                {
                    label: "Comments",
                    backgroundColor: "lightgrey",
                    borderColor: "grey",
                    borderWidth: 1,
                    data: [5296, 86, 9, 0]
                },
                {
                    label: "Blank",
                    backgroundColor: "lightblue",
                    borderColor: "blue",
                    borderWidth: 1,
                    data: [19515, 1153, 1288, 1948]
                },
            ]
        },
        options: {
            responsive: true,
            legend: {
                position: "top"
            },
            title: {
                display: true,
                text: "Lines of Code"
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }

    });
</script>


